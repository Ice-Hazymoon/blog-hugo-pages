!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Artalk=e()}(this,(function(){"use strict";function t(t=""){const e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild||e}function e(t){const e=RegExp(`[?&]${t}=([^&]*)`).exec(window.location.search);return e&&decodeURIComponent(e[1].replace(/\+/g," "))}function i(t){const e=t.getBoundingClientRect();return{top:e.top+window.scrollY,left:e.left+window.scrollX}}function n(t,e){let i=t.toString();for(;i.length<e;)i=`0${i}`;return i}function s(t){try{const e=t.getTime(),i=(new Date).getTime()-e,s=Math.floor(i/864e5);if(0===s){const t=i%864e5,e=Math.floor(t/36e5);if(0===e){const e=t%36e5,i=Math.floor(e/6e4);if(0===i){const t=e%6e4;return`${Math.round(t/1e3)} 秒前`}return`${i} 分钟前`}return`${e} 小时前`}return s<0?"刚刚":s<8?`${s} 天前`:function(t){const e=n(t.getDate(),2),i=n(t.getMonth()+1,2);return`${n(t.getFullYear(),2)}-${i}-${e}`}(t)}catch(e){return console.error(e)," - "}}class a{data;constructor(t){const e=JSON.parse(window.localStorage.getItem("ArtalkUser")||"{}");this.data={nick:e.nick||"",email:e.email||"",link:e.link||"",token:e.token||"",isAdmin:e.isAdmin||!1}}save(){window.localStorage.setItem("ArtalkUser",JSON.stringify(this.data))}checkHasBasicUserInfo(){return!!this.data.nick&&!!this.data.email}}class r{cid;rootEl;conf;user;eventList=[];constructor(t,e){this.cid=+new Date,this.rootEl=t,this.conf=e,this.user=new a(this.conf)}on(t,e,i="internal"){this.eventList.push({name:t,handler:e,scope:i})}off(t,e,i="internal"){this.eventList=this.eventList.filter((n=>e?!(n.name===t&&n.handler===e&&n.scope===i):!(n.name===t&&n.scope===i)))}trigger(t,e,i){this.eventList.filter((e=>e.name===t&&(!i||e.scope===i))).map((t=>t.handler)).forEach((t=>t(e)))}}function o(e){e instanceof r&&(e=e.rootEl);let i=e.querySelector(".atk-loading");i||(i=t('\n        <div class="atk-loading" style="display: none;">\n          <div class="atk-loading-spinner">\n          <svg viewBox="25 25 50 50"><circle cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle></svg>\n          </div>\n          </div>'),e.appendChild(i)),i.style.display=""}function l(t){t instanceof r&&(t=t.rootEl);const e=t.querySelector(".atk-loading");e&&(e.style.display="none")}function c(t){const e=window.scrollY,n=e+document.documentElement.clientHeight,s=i(t).top;return s+t.offsetHeight<=n&&s>=e}function d(t,e=!0){if(c(t))return;const n=i(t).top+parseFloat(getComputedStyle(t,null).height.replace("px",""))/2-document.documentElement.clientHeight/2;e?window.scroll({top:n>0?n:0,left:0,behavior:"smooth"}):window.scroll(0,n>0?n:0)}function h(e,i,n){const s=t(`<div class="atk-notify atk-fade-in" style="background-color: ${{s:"#57d59f",e:"#ff6f6c",w:"#ffc721",i:"#2ebcfc"}[n]}"><span class="atk-notify-content"></span></div>`);s.querySelector(".atk-notify-content").innerHTML=function(t){const e=document.createElement("div");return e.innerText=t,e.innerHTML}(i).replace("\n","<br/>"),e.appendChild(s);const a=()=>{s.classList.add("atk-fade-out"),setTimeout((()=>{s.remove()}),200)};let r;r=window.setTimeout((()=>{a()}),3e3),s.addEventListener("click",(()=>{a(),window.clearTimeout(r)}))}function p(t,e){!function(t,e,i="in"){t.classList.add(`atk-fade-${i}`);const n=()=>{t.classList.remove(`atk-fade-${i}`),t.removeEventListener("animationend",n),e&&e()};t.addEventListener("animationend",n)}(t,e,"in")}function m(e,i,n='<span class="atk-error-title">Artalk Error</span>'){e instanceof r&&(e=e.rootEl);let s=e.querySelector(".atk-error-layer");if(null===i)return void(null!==s&&s.remove());s||(s=t(`<div class="atk-error-layer">${n}<span class="atk-error-text"></span></div>`),e.appendChild(s));const a=s.querySelector(".atk-error-text");a.innerHTML="",null!==i&&(i instanceof HTMLElement?a.appendChild(i):a.innerText=i)}class u{el;ctx;conf;constructor(t){this.ctx=t,this.conf=t.conf}}const g="atk-dark-mode";function y(e){let i=document.querySelector(`.atk-layer-wrap#ctx-${e.cid}`);i||(i=t(`<div class="atk-layer-wrap" id="ctx-${e.cid}" style="display: none;"><div class="atk-layer-mask"></div></div>`),document.body.appendChild(i));const n=i.querySelector(".atk-layer-mask");return i&&(e.conf.darkMode?i.classList.add(g):i.classList.remove(g)),{wrapEl:i,maskEl:n}}function k(t,e,i){return new f(t,e,i)}class f extends u{name;wrapEl;maskEl;maskClickHideEnable=!0;bodyStyleOrgOverflow="";bodyStyleOrgPaddingRight="";constructor(e,i,n){super(e),this.name=i;const{wrapEl:s,maskEl:a}=y(e);this.wrapEl=s,this.maskEl=a,this.el=this.wrapEl.querySelector(`[data-layer-name="${i}"].atk-layer-item`),null===this.el&&(n?this.el=n:(this.el=t(),this.el.classList.add("atk-layer-item"))),this.el.setAttribute("data-layer-name",i),this.el.style.display="none",this.wrapEl.append(this.el)}getName(){return this.name}getWrapEl(){return this.wrapEl}getEl(){return this.el}static hideTimeoutList=[];show(){f.hideTimeoutList.forEach((t=>{clearTimeout(t)})),f.hideTimeoutList=[],this.wrapEl.style.display="block",this.maskEl.style.display="block",this.maskEl.classList.add("atk-fade-in"),this.el.style.display="",this.maskEl.onclick=()=>{this.maskClickHideEnable&&this.hide()},this.bodyStyleOrgOverflow=document.body.style.overflow,this.bodyStyleOrgPaddingRight=document.body.style.paddingRight,document.body.style.overflow="hidden";const t=parseInt(window.getComputedStyle(document.body,null).getPropertyValue("padding-right"),10);document.body.style.paddingRight=`${function(){const t=document.createElement("p");t.style.width="100%",t.style.height="200px";const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(t),document.body.appendChild(e);const i=t.offsetWidth;e.style.overflow="scroll";let n=t.offsetWidth;return i===n&&(n=e.clientWidth),document.body.removeChild(e),i-n}()+t||0}px`}hide(){f.hideTimeoutList.push(window.setTimeout((()=>{this.wrapEl.style.display="none",document.body.style.overflow=this.bodyStyleOrgOverflow,document.body.style.paddingRight=this.bodyStyleOrgPaddingRight}),450)),this.wrapEl.classList.add("atk-fade-out"),f.hideTimeoutList.push(window.setTimeout((()=>{this.wrapEl.style.display="none",this.wrapEl.classList.remove("atk-fade-out")}),200)),this.el.style.display="none"}setMaskClickHide(t){this.maskClickHideEnable=t}disposeNow(){document.body.style.overflow="",this.el.remove(),this.checkCleanLayer()}dispose(){this.hide(),this.el.remove(),this.checkCleanLayer()}checkCleanLayer(){0===this.getWrapEl().querySelectorAll(".atk-layer-item").length&&(this.wrapEl.style.display="none")}}async function v(t,e,i){if(t.user.data.token){const e=new Headers;e.set("Authorization",`Bearer ${t.user.data.token}`),i.headers=e}try{const a=await(n=t.conf.reqTimeout||15e3,s=fetch(e,i),new Promise(((t,e)=>{const i=setTimeout((()=>{e(new Error("请求超时"))}),n);s.then((e=>{clearTimeout(i),t(e)}),(t=>{clearTimeout(i),e(t)}))})));if(!a.ok&&401!==a.status)throw new Error(`请求响应 ${a.status}`);let r=await a.json();const o=(n,s)=>{v(t,e,i).then((t=>{n(t)})).catch((t=>{s(t)}))};if(r.data&&r.data.need_captcha?r=await new Promise(((e,i)=>{t.trigger("checker-captcha",{imgData:r.data.img_data,onSuccess:()=>{o(e,i)},onCancel:()=>{i(r)}})})):(r.data&&r.data.need_login||401===a.status)&&(r=await new Promise(((e,i)=>{t.trigger("checker-admin",{onSuccess:()=>{o(e,i)},onCancel:()=>{i(r)}})}))),!r.success)throw r;return r}catch(a){if(console.error(a),a instanceof TypeError)throw new Error("网络错误");throw a}var n,s}async function x(t,e,i){const n={method:"POST"};i&&(n.body=w(i));return(await v(t,e,n)).data||{}}async function E(t,e,i){return(await v(t,e+(i?`?${new URLSearchParams(i)}`:""),{method:"GET"})).data||{}}function w(t){const e=new FormData;return Object.keys(t).forEach((i=>e.append(i,String(t[i])))),e}class b{ctx;baseURL;constructor(t){this.ctx=t,this.baseURL=t.conf.server}get(t,e,i,n){const s={page_key:this.ctx.conf.pageKey,site_name:this.ctx.conf.site||"",limit:this.ctx.conf.readMore?.pageSize||15,offset:t};return e&&(s.type=e),i&&(s.flat_mode=i),this.ctx.user.checkHasBasicUserInfo()&&(s.name=this.ctx.user.data.nick,s.email=this.ctx.user.data.email),n&&n(s),x(this.ctx,`${this.baseURL}/get`,s)}async add(t){const e={name:t.nick,email:t.email,link:t.link,content:t.content,rid:t.rid,page_key:this.ctx.conf.pageKey,page_title:this.ctx.conf.pageTitle||""};this.ctx.conf.site&&(e.site_name=this.ctx.conf.site);return(await x(this.ctx,`${this.baseURL}/add`,e)).comment}async commentEdit(t){const e={...t};return(await x(this.ctx,`${this.baseURL}/admin/comment-edit`,e)).comment}commentDel(t,e){const i={id:String(t),site_name:e||""};return x(this.ctx,`${this.baseURL}/admin/comment-del`,i)}async login(t,e,i){const n={name:t,email:e,password:i};this.ctx.conf.site&&(n.site_name=this.ctx.conf.site);return(await x(this.ctx,`${this.baseURL}/login`,n)).token}userGet(t,e){const i=new AbortController,{signal:n}=i,s={name:t,email:e,site_name:this.ctx.conf.site||""};return{req:v(this.ctx,`${this.baseURL}/user-get`,{method:"POST",body:w(s),signal:n}).then((t=>({user:t.data.user,is_login:t.data.is_login,unread:t.data.unread||[],unread_count:t.data.unread_count||0}))),abort:()=>{i.abort()}}}async pageGet(t){const e={site_name:t||""};return(await x(this.ctx,`${this.baseURL}/admin/page-get`,e)).pages}async pageEdit(t){const e={id:t.id,key:t.key,title:t.title,admin_only:t.admin_only,site_name:t.site_name||this.ctx.conf.site};return(await x(this.ctx,`${this.baseURL}/admin/page-edit`,e)).page}pageDel(t,e){const i={key:String(t),site_name:e||""};return x(this.ctx,`${this.baseURL}/admin/page-del`,i)}async pageFetch(t){const e={id:t};return(await x(this.ctx,`${this.baseURL}/admin/page-fetch`,e)).page}async siteGet(){return(await x(this.ctx,`${this.baseURL}/admin/site-get`,{})).sites}async siteAdd(t,e){const i={name:t,urls:e};return(await x(this.ctx,`${this.baseURL}/admin/site-add`,i)).site}async siteEdit(t,e){const i={id:t,name:e.name,urls:e.urls};return(await x(this.ctx,`${this.baseURL}/admin/site-edit`,i)).site}siteDel(t,e=!1){const i={id:t,del_content:e};return x(this.ctx,`${this.baseURL}/admin/site-del`,i)}async vote(t,e){const i={site_name:this.ctx.conf.site||"",target_id:t,type:e};this.ctx.user.checkHasBasicUserInfo()&&(i.name=this.ctx.user.data.nick,i.email=this.ctx.user.data.email);return(await x(this.ctx,`${this.baseURL}/vote`,i))?.vote_num||0}markRead(t,e=!1){const i={site_name:this.ctx.conf.site||"",notify_key:t};return e&&(delete i.notify_key,i.read_all=!0,i.name=this.ctx.user.data.nick,i.email=this.ctx.user.data.email),x(this.ctx,`${this.baseURL}/mark-read`,i)}async captchaGet(){return(await E(this.ctx,`${this.baseURL}/captcha/refresh`)).img_data||""}async captchaCheck(t){return(await E(this.ctx,`${this.baseURL}/captcha/check`,{value:t})).img_data||""}}const S={request:(t,e)=>{const i={name:t.user.data.nick,email:t.user.data.email,password:e};return new b(t.ctx).login(i.name,i.email,i.password)},body:()=>t("<span>敲入密码来验证管理员身份：</span>"),onSuccess:(t,e,i,n)=>{t.user.data.isAdmin=!0,t.user.data.token=e,t.user.save(),t.ctx.trigger("user-changed",t.ctx.user.data),t.ctx.trigger("list-reload")},onError:(t,e,i,n)=>{}},L={request:(t,e)=>new b(t.ctx).captchaCheck(e),body:e=>{const i=t(`<span><img class="atk-captcha-img" src="${e.submitCaptchaImgData||""}" alt="验证码">敲入验证码继续：</span>`);return i.querySelector(".atk-captcha-img").onclick=()=>{const t=i.querySelector(".atk-captcha-img");new b(e.ctx).captchaGet().then((e=>{t.setAttribute("src",e)})).catch((t=>{console.error("验证码获取失败 ",t)}))},i},onSuccess:(t,e,i,n,s)=>{t.submitCaptchaVal=n},onError:(t,e,i,n)=>{n.querySelector(".atk-captcha-img").click()}};class C{ctx;user;submitCaptchaVal;submitCaptchaImgData;constructor(t){this.ctx=t,this.user=t.user,this.ctx.on("checker-captcha",(t=>{t.imgData&&(this.submitCaptchaImgData=t.imgData),this.check("captcha",t)})),this.ctx.on("checker-admin",(t=>{this.check("admin",t)}))}check(e,i){const n={admin:S,captcha:L}[e],s=k(this.ctx,`checker-${(new Date).getTime()}`);s.setMaskClickHide(!1),s.show();const a=t();a.appendChild(n.body(this));const r=t(`<input id="check" type="${"admin"===e?"password":"text"}" required placeholder="">`);let o;a.appendChild(r),setTimeout((()=>{r.focus()}),80),r.onkeyup=t=>{"Enter"!==t.key&&13!==t.keyCode||(t.preventDefault(),s.getEl().querySelector('button[data-action="confirm"]').click())};const l=function(e,i,n){const s=t('<div class="atk-layer-dialog-wrap">\n      <div class="atk-layer-dialog">\n      <div class="atk-layer-dialog-content"></div>\n      <div class="atk-layer-dialog-action">\n      </div>'),a=s.querySelector(".atk-layer-dialog-action"),r=t=>e=>{const i=t(e.currentTarget);void 0!==i&&!0!==i||s.remove()};if("function"==typeof i){const e=t('<button data-action="confirm">确定</button>');e.onclick=r(i),a.appendChild(e)}if("function"==typeof n){const e=t('<button data-action="cancel">取消</button>');e.onclick=r(n),a.appendChild(e)}return s.querySelector(".atk-layer-dialog-content").appendChild(e),s}(a,(t=>{const e=r.value.trim();o||(o=t.innerText);const c=()=>{t.innerText=o||"",t.classList.remove("error")};return t.innerText="加载中...",n.request(this,e).then((t=>{s.disposeNow(),n.onSuccess&&n.onSuccess(this,t,e,a),i.onSuccess&&i.onSuccess(e,l)})).catch((i=>{var s;s=String(i.msg||String(i)),t.innerText=s,t.classList.add("error"),n.onError&&n.onError(this,i,e,a);const o=setTimeout((()=>{c()}),3e3);r.onfocus=()=>{c(),clearTimeout(o)}})),!1}),(()=>(s.disposeNow(),i.onCancel&&i.onCancel(),!1)));s.getEl().append(l),i.onMount&&i.onMount(l)}}class T extends class{editor;ctx;el;constructor(t){this.editor=t,this.ctx=t.ctx}}{constructor(t){super(t),this.editor=t,this.emoticons=this.ctx.conf.emoticons,this.initEl()}el;emoticons;listWrapEl;typesEl;initEl(){this.el=t('<div class="atk-editor-plug-emoticons"></div>'),this.listWrapEl=t('<div class="atk-emoticons-list-wrap"></div>'),this.el.append(this.listWrapEl),Object.entries(this.emoticons).forEach((([e,i])=>{const n=t('<div class="atk-emoticons-list" style="display: none;"></div>');this.listWrapEl.append(n),n.setAttribute("data-key",e),n.setAttribute("data-input-type",i.inputType),Object.entries(i.container).forEach((([e,s])=>{const a=t('<span class="atk-emoticons-item"></span>');if(n.append(a),a.setAttribute("title",e),a.setAttribute("data-content",s),"image"===i.inputType){const t=document.createElement("img");t.src=s,t.alt=e,a.append(t)}else a.innerText=s}))})),this.typesEl=t('<div class="atk-emoticons-types"></div>'),this.el.append(this.typesEl),Object.entries(this.emoticons).forEach((([e,i])=>{const n=t("<span />");this.typesEl.append(n),n.setAttribute("data-key",e),n.innerText=e})),this.typesEl.querySelectorAll("span").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.getAttribute("data-key");e&&this.openType(e)}))})),Object.keys(this.emoticons).length>0&&this.openType(Object.keys(this.emoticons)[0]),this.listWrapEl.querySelectorAll(".atk-emoticons-item").forEach((t=>{t.onclick=t=>{const e=t.currentTarget,i=e.closest(".atk-emoticons-list").getAttribute("data-input-type"),n=e.getAttribute("title"),s=e.getAttribute("data-content");"image"===i?this.editor.insertContent(`:[${n}]`):this.editor.insertContent(s||"")}}))}openType(t){Array.from(this.listWrapEl.children).forEach((e=>{const i=e;i.getAttribute("data-key")!==t?i.style.display="none":i.style.display=""})),this.typesEl.querySelectorAll("span.active").forEach((t=>t.classList.remove("active"))),this.typesEl.querySelector(`span[data-key="${t}"]`)?.classList.add("active"),this.changeListHeight()}getName(){return"emoticons"}getBtnHtml(){return"表情"}getEl(){return this.el}changeListHeight(){}onShow(){setTimeout((()=>{this.changeListHeight()}),30)}onHide(){this.el.parentElement.style.height=""}transEmoticonImageText(t){return Object.entries(this.emoticons).forEach((([e,i])=>{"image"===i.inputType&&Object.entries(i.container).forEach((([e,i])=>{t=t.split(`:[${e}]`).join(`![${e}](${i}) `)}))})),t}}class $ extends u{LOADABLE_PLUG_LIST=[T];plugList={};el;headerEl;textareaWrapEl;textareaEl;closeCommentEl;plugWrapEl;bottomEl;bottomPartLeftEl;plugSwitcherWrapEl;bottomPartRightEl;submitBtn;notifyWrapEl;replyComment=null;sendReplyEl=null;get user(){return this.ctx.user}constructor(e){super(e),this.el=t('<div class="atk-editor">\r\n  <div class="atk-editor-header">\r\n    <input name="nick" placeholder="昵称" class="atk-nick" type="text" required="required">\r\n    <input name="email" placeholder="邮箱" class="atk-email" type="email" required="required">\r\n    <input name="link" placeholder="网址 (https://)" class="atk-link" type="url">\r\n  </div>\r\n  <div class="atk-editor-textarea-wrap">\r\n    <div class="atk-close-comment" style="display: none;"><span>仅管理员可评论</span></div>\r\n    <textarea id="atk-editor-textarea" class="atk-editor-textarea" placeholder=""></textarea>\r\n  </div>\r\n  <div class="atk-editor-plug-wrap" style="display: none;"></div>\r\n  <div class="atk-editor-bottom">\r\n    <div class="atk-editor-bottom-part atk-left atk-editor-plug-switcher-wrap"></div>\r\n    <div class="atk-editor-bottom-part atk-right">\r\n      <button type="button" class="atk-send-btn"></button>\r\n    </div>\r\n  </div>\r\n  <div class="atk-editor-notify-wrap"></div>\r\n</div>\r\n'),this.headerEl=this.el.querySelector(".atk-editor-header"),this.textareaWrapEl=this.el.querySelector(".atk-editor-textarea-wrap"),this.textareaEl=this.el.querySelector(".atk-editor-textarea"),this.closeCommentEl=this.el.querySelector(".atk-close-comment"),this.plugWrapEl=this.el.querySelector(".atk-editor-plug-wrap"),this.bottomEl=this.el.querySelector(".atk-editor-bottom"),this.bottomPartLeftEl=this.el.querySelector(".atk-editor-bottom-part.atk-left"),this.plugSwitcherWrapEl=this.el.querySelector(".atk-editor-plug-switcher-wrap"),this.bottomPartRightEl=this.el.querySelector(".atk-editor-bottom-part.atk-right"),this.submitBtn=this.el.querySelector(".atk-send-btn"),this.notifyWrapEl=this.el.querySelector(".atk-editor-notify-wrap"),this.initLocalStorage(),this.initHeader(),this.initTextarea(),this.initEditorPlug(),this.initBottomPart(),this.ctx.on("editor-open",(()=>this.open())),this.ctx.on("editor-close",(()=>this.close())),this.ctx.on("editor-reply",(t=>this.setReply(t))),this.ctx.on("editor-show-loading",(()=>o(this.el))),this.ctx.on("editor-hide-loading",(()=>l(this.el))),this.ctx.on("editor-notify",(t=>this.showNotify(t.msg,t.type)))}initLocalStorage(){const t=window.localStorage.getItem("ArtalkContent")||"";""!==t.trim()&&(this.showNotify("已自动恢复","i"),this.setContent(t)),this.textareaEl.addEventListener("input",(()=>{this.saveContent()}))}initHeader(){Object.keys(this.user.data).forEach((t=>{const e=this.getInputEl(t);e&&e instanceof HTMLInputElement&&(e.value=this.user.data[t]||"",e.addEventListener("input",(()=>this.onHeaderInputChanged(t,e))))}))}getInputEl(t){return this.headerEl.querySelector(`[name="${t}"]`)}queryUserInfo={timeout:null,abortFunc:null};onHeaderInputChanged(t,e){this.user.data[t]=e.value.trim(),"nick"!==t&&"email"!==t||(this.user.data.token="",this.user.data.isAdmin=!1,null!==this.queryUserInfo.timeout&&window.clearTimeout(this.queryUserInfo.timeout),null!==this.queryUserInfo.abortFunc&&this.queryUserInfo.abortFunc(),this.queryUserInfo.timeout=window.setTimeout((()=>{this.queryUserInfo.timeout=null;const{req:t,abort:e}=new b(this.ctx).userGet(this.user.data.nick,this.user.data.email);this.queryUserInfo.abortFunc=e,t.then((t=>{t.is_login||(this.user.data.token="",this.user.data.isAdmin=!1),this.ctx.trigger("unread-update",{notifies:t.unread}),this.user.checkHasBasicUserInfo()&&!t.is_login&&t.user&&t.user.is_admin&&this.showLoginDialog(),t.user&&t.user.link&&(this.user.data.link=t.user.link,this.getInputEl("link").value=t.user.link)})).finally((()=>{this.queryUserInfo.abortFunc=null}))}),400)),this.saveUser()}showLoginDialog(){this.ctx.trigger("checker-admin",{onSuccess:()=>{}})}saveUser(){this.user.save(),this.ctx.trigger("user-changed",this.ctx.user.data)}saveContent(){window.localStorage.setItem("ArtalkContent",this.getContentOriginal().trim())}initTextarea(){this.textareaEl.placeholder=this.ctx.conf.placeholder||"",this.textareaEl.addEventListener("keydown",(t=>{9===(t.keyCode||t.which)&&(t.preventDefault(),this.insertContent("\t"))})),this.textareaEl.addEventListener("input",(t=>{this.adjustTextareaHeight()}))}adjustTextareaHeight(){const t=this.textareaEl.offsetHeight-this.textareaEl.clientHeight;this.textareaEl.style.height="0px",this.textareaEl.style.height=`${this.textareaEl.scrollHeight+t}px`}openedPlugName=null;initEditorPlug(){this.plugList={},this.plugWrapEl.innerHTML="",this.plugWrapEl.style.display="none",this.openedPlugName=null,this.plugSwitcherWrapEl.innerHTML="",this.LOADABLE_PLUG_LIST.forEach((e=>{const i=new e(this);this.plugList[i.getName()]=i;const n=t(`<span class="atk-editor-action atk-editor-plug-switcher">${i.getBtnHtml()}</span>`);this.plugSwitcherWrapEl.appendChild(n),n.addEventListener("click",(()=>{if(this.plugSwitcherWrapEl.querySelectorAll(".active").forEach((t=>t.classList.remove("active"))),i.getName()===this.openedPlugName)return i.onHide(),this.plugWrapEl.style.display="none",void(this.openedPlugName=null);if(null===this.plugWrapEl.querySelector(`[data-plug-name="${i.getName()}"]`)){const t=i.getEl();t.setAttribute("data-plug-name",i.getName()),t.style.display="none",this.plugWrapEl.appendChild(t)}Array.from(this.plugWrapEl.children).forEach((t=>{const e=t.getAttribute("data-plug-name");e===i.getName()?(t.style.display="",this.plugList[e].onShow()):(t.style.display="none",this.plugList[e].onHide())})),this.plugWrapEl.style.display="",this.openedPlugName=i.getName(),n.classList.add("active")}))}))}closePlug(){this.plugWrapEl.innerHTML="",this.plugWrapEl.style.display="none",this.openedPlugName=null}insertContent(t){if(document.selection)this.textareaEl.focus(),document.selection.createRange().text=t,this.textareaEl.focus();else if(this.textareaEl.selectionStart||0===this.textareaEl.selectionStart){const e=this.textareaEl.selectionStart,i=this.textareaEl.selectionEnd,n=this.textareaEl.scrollTop;this.setContent(this.textareaEl.value.substring(0,e)+t+this.textareaEl.value.substring(i,this.textareaEl.value.length)),this.textareaEl.focus(),this.textareaEl.selectionStart=e+t.length,this.textareaEl.selectionEnd=e+t.length,this.textareaEl.scrollTop=n}else this.textareaEl.focus(),this.textareaEl.value+=t}setContent(t){this.textareaEl.value=t,this.saveContent(),this.plugList&&this.plugList.preview&&this.plugList.preview.updateContent(),this.adjustTextareaHeight()}clearEditor(){this.setContent(""),this.cancelReply()}getContent(){let t=this.getContentOriginal();if(this.plugList&&this.plugList.emoticons){t=this.plugList.emoticons.transEmoticonImageText(t)}return t}getContentOriginal(){return this.textareaEl.value||""}initBottomPart(){this.initReply(),this.initSubmit()}initReply(){this.replyComment=null,this.sendReplyEl=null}setReply(e){null!==this.replyComment&&this.cancelReply(),null===this.sendReplyEl&&(this.sendReplyEl=t('<div class="atk-send-reply-wrap"><div class="atk-send-reply">回复 <span class="atk-text"></span><span class="atk-cancel" title="取消 AT">×</span></div></div>'),this.sendReplyEl.querySelector(".atk-text").innerText=`@${e.nick}`,this.sendReplyEl.addEventListener("click",(()=>{this.cancelReply()})),this.textareaWrapEl.prepend(this.sendReplyEl)),this.replyComment=e,d(this.el),this.textareaEl.focus()}cancelReply(){null!==this.sendReplyEl&&(this.sendReplyEl.remove(),this.sendReplyEl=null),this.replyComment=null}initSubmit(){this.submitBtn.innerText=this.ctx.conf.sendBtn||"Send",this.submitBtn.addEventListener("click",(t=>{t.currentTarget,this.submit()}))}async submit(){if(""!==this.getContent().trim()){this.ctx.trigger("editor-submit"),o(this.el);try{const t=await new b(this.ctx).add({content:this.getContent(),nick:this.user.data.nick,email:this.user.data.email,link:this.user.data.link,rid:null===this.replyComment?0:this.replyComment.id});this.ctx.trigger("list-insert",t),this.clearEditor(),this.ctx.trigger("editor-submitted")}catch(t){console.error(t),this.showNotify(`评论失败，${t.msg||String(t)}`,"e")}finally{l(this.el)}}else this.textareaEl.focus()}showNotify(t,e){h(this.notifyWrapEl,t,e)}close(){this.closeCommentEl.style.display="",this.user.data.isAdmin?(this.textareaEl.style.display="",this.bottomEl.style.display=""):(this.textareaEl.style.display="none",this.closePlug(),this.bottomEl.style.display="none")}open(){this.closeCommentEl.style.display="none",this.textareaEl.style.display="",this.bottomEl.style.display=""}}var O=window||{},M=navigator||{};function A(t){var e=t||M.userAgent,i=this,n={Trident:e.indexOf("Trident")>-1||e.indexOf("NET CLR")>-1,Presto:e.indexOf("Presto")>-1,WebKit:e.indexOf("AppleWebKit")>-1,Gecko:e.indexOf("Gecko/")>-1,Safari:e.indexOf("Safari")>-1,Chrome:e.indexOf("Chrome")>-1||e.indexOf("CriOS")>-1,IE:e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1,Edge:e.indexOf("Edge")>-1,Firefox:e.indexOf("Firefox")>-1||e.indexOf("FxiOS")>-1,"Firefox Focus":e.indexOf("Focus")>-1,Chromium:e.indexOf("Chromium")>-1,Opera:e.indexOf("Opera")>-1||e.indexOf("OPR")>-1,Vivaldi:e.indexOf("Vivaldi")>-1,Yandex:e.indexOf("YaBrowser")>-1,Kindle:e.indexOf("Kindle")>-1||e.indexOf("Silk/")>-1,360:e.indexOf("360EE")>-1||e.indexOf("360SE")>-1,UC:e.indexOf("UC")>-1||e.indexOf(" UBrowser")>-1,QQBrowser:e.indexOf("QQBrowser")>-1,QQ:e.indexOf("QQ/")>-1,Baidu:e.indexOf("Baidu")>-1||e.indexOf("BIDUBrowser")>-1,Maxthon:e.indexOf("Maxthon")>-1,Sogou:e.indexOf("MetaSr")>-1||e.indexOf("Sogou")>-1,LBBROWSER:e.indexOf("LBBROWSER")>-1,"2345Explorer":e.indexOf("2345Explorer")>-1,TheWorld:e.indexOf("TheWorld")>-1,XiaoMi:e.indexOf("MiuiBrowser")>-1,Quark:e.indexOf("Quark")>-1,Qiyu:e.indexOf("Qiyu")>-1,Wechat:e.indexOf("MicroMessenger")>-1,Taobao:e.indexOf("AliApp(TB")>-1,Alipay:e.indexOf("AliApp(AP")>-1,Weibo:e.indexOf("Weibo")>-1,Douban:e.indexOf("com.douban.frodo")>-1,Suning:e.indexOf("SNEBUY-APP")>-1,iQiYi:e.indexOf("IqiyiApp")>-1,Windows:e.indexOf("Windows")>-1,Linux:e.indexOf("Linux")>-1||e.indexOf("X11")>-1,"Mac OS":e.indexOf("Macintosh")>-1,Android:e.indexOf("Android")>-1||e.indexOf("Adr")>-1,Ubuntu:e.indexOf("Ubuntu")>-1,FreeBSD:e.indexOf("FreeBSD")>-1,Debian:e.indexOf("Debian")>-1,"Windows Phone":e.indexOf("IEMobile")>-1||e.indexOf("Windows Phone")>-1,BlackBerry:e.indexOf("BlackBerry")>-1||e.indexOf("RIM")>-1,MeeGo:e.indexOf("MeeGo")>-1,Symbian:e.indexOf("Symbian")>-1,iOS:e.indexOf("like Mac OS X")>-1,"Chrome OS":e.indexOf("CrOS")>-1,WebOS:e.indexOf("hpwOS")>-1,Mobile:e.indexOf("Mobi")>-1||e.indexOf("iPh")>-1||e.indexOf("480")>-1,Tablet:e.indexOf("Tablet")>-1||e.indexOf("Pad")>-1||e.indexOf("Nexus 7")>-1};n.Mobile?n.Mobile=!(e.indexOf("iPad")>-1):O.showModalDialog&&O.chrome&&(n[360]=!0);var s,a={engine:["WebKit","Trident","Gecko","Presto"],browser:["Safari","Chrome","Edge","IE","Firefox","Firefox Focus","Chromium","Opera","Vivaldi","Yandex","Kindle","360","UC","QQBrowser","QQ","Baidu","Maxthon","Sogou","LBBROWSER","2345Explorer","TheWorld","XiaoMi","Quark","Qiyu","Wechat","Taobao","Alipay","Weibo","Douban","Suning","iQiYi"],os:["Windows","Linux","Mac OS","Android","Ubuntu","FreeBSD","Debian","iOS","Windows Phone","BlackBerry","MeeGo","Symbian","Chrome OS","WebOS"],device:["Mobile","Tablet"]};for(var r in i.device="PC",i.language=((s=(M.browserLanguage||M.language).split("-"))[1]&&(s[1]=s[1].toUpperCase()),s.join("_")),a)for(var o=0;o<a[r].length;o++){var l=a[r][o];n[l]&&(i[r]=l)}var c={Windows:function(){var t=e.replace(/^.*Windows NT ([\d.]+);.*$/,"$1");return{6.4:"10",6.3:"8.1",6.2:"8",6.1:"7","6.0":"Vista",5.2:"XP",5.1:"XP","5.0":"2000"}[t]||t},Android:function(){return e.replace(/^.*Android ([\d.]+);.*$/,"$1")},iOS:function(){return e.replace(/^.*OS ([\d_]+) like.*$/,"$1").replace(/_/g,".")},Debian:function(){return e.replace(/^.*Debian\/([\d.]+).*$/,"$1")},"Windows Phone":function(){return e.replace(/^.*Windows Phone( OS)? ([\d.]+);.*$/,"$2")},"Mac OS":function(){return e.replace(/^.*Mac OS X ([\d_]+).*$/,"$1").replace(/_/g,".")},WebOS:function(){return e.replace(/^.*hpwOS\/([\d.]+);.*$/,"$1")}};i.osVersion="",c[i.os]&&(i.osVersion=c[i.os](),i.osVersion===e&&(i.osVersion=""));var d={Safari:function(){return e.replace(/^.*Version\/([\d.]+).*$/,"$1")},Chrome:function(){return e.replace(/^.*Chrome\/([\d.]+).*$/,"$1").replace(/^.*CriOS\/([\d.]+).*$/,"$1")},IE:function(){return e.replace(/^.*MSIE ([\d.]+).*$/,"$1").replace(/^.*rv:([\d.]+).*$/,"$1")},Edge:function(){return e.replace(/^.*Edge\/([\d.]+).*$/,"$1")},Firefox:function(){return e.replace(/^.*Firefox\/([\d.]+).*$/,"$1").replace(/^.*FxiOS\/([\d.]+).*$/,"$1")},"Firefox Focus":function(){return e.replace(/^.*Focus\/([\d.]+).*$/,"$1")},Chromium:function(){return e.replace(/^.*Chromium\/([\d.]+).*$/,"$1")},Opera:function(){return e.replace(/^.*Opera\/([\d.]+).*$/,"$1").replace(/^.*OPR\/([\d.]+).*$/,"$1")},Vivaldi:function(){return e.replace(/^.*Vivaldi\/([\d.]+).*$/,"$1")},Yandex:function(){return e.replace(/^.*YaBrowser\/([\d.]+).*$/,"$1")},Kindle:function(){return e.replace(/^.*Version\/([\d.]+).*$/,"$1")},Maxthon:function(){return e.replace(/^.*Maxthon\/([\d.]+).*$/,"$1")},QQBrowser:function(){return e.replace(/^.*QQBrowser\/([\d.]+).*$/,"$1")},QQ:function(){return e.replace(/^.*QQ\/([\d.]+).*$/,"$1")},Baidu:function(){return e.replace(/^.*BIDUBrowser[\s/]([\d.]+).*$/,"$1")},UC:function(){return e.replace(/^.*UC?Browser\/([\d.]+).*$/,"$1")},Sogou:function(){return e.replace(/^.*SE ([\d.X]+).*$/,"$1").replace(/^.*SogouMobileBrowser\/([\d.]+).*$/,"$1")},"2345Explorer":function(){return e.replace(/^.*2345Explorer\/([\d.]+).*$/,"$1")},TheWorld:function(){return e.replace(/^.*TheWorld ([\d.]+).*$/,"$1")},XiaoMi:function(){return e.replace(/^.*MiuiBrowser\/([\d.]+).*$/,"$1")},Quark:function(){return e.replace(/^.*Quark\/([\d.]+).*$/,"$1")},Qiyu:function(){return e.replace(/^.*Qiyu\/([\d.]+).*$/,"$1")},Wechat:function(){return e.replace(/^.*MicroMessenger\/([\d.]+).*$/,"$1")},Taobao:function(){return e.replace(/^.*AliApp\(TB\/([\d.]+).*$/,"$1")},Alipay:function(){return e.replace(/^.*AliApp\(AP\/([\d.]+).*$/,"$1")},Weibo:function(){return e.replace(/^.*weibo__([\d.]+).*$/,"$1")},Douban:function(){return e.replace(/^.*com.douban.frodo\/([\d.]+).*$/,"$1")},Suning:function(){return e.replace(/^.*SNEBUY-APP([\d.]+).*$/,"$1")},iQiYi:function(){return e.replace(/^.*IqiyiVersion\/([\d.]+).*$/,"$1")}};i.version="",d[i.browser]&&(i.version=d[i.browser](),i.version===e&&(i.version="")),i.version.indexOf(".")&&(i.version=i.version.substring(0,i.version.indexOf("."))),"Edge"===i.browser?i.engine="EdgeHTML":"Chrome"===i.browser&&parseInt(i.version)>27||"Opera"===i.browser&&parseInt(i.version)>12||"Yandex"===i.browser?i.engine="Blink":void 0===i.browser&&(i.browser="Unknow App")}function q(t){return new A(t)}class _ extends u{data;mainEl;bodyEl;contentEl;childrenEl;actionsEl;parent;nestedNum;maxNestingNum;children=[];replyTo;afterRender;unread=!1;openable=!1;openURL;openEvt;constructor(t,e){super(t),this.maxNestingNum=t.conf.maxNesting||3,this.data={...e},this.data.date=this.data.date.replace(/-/g,"/"),this.parent=null,this.nestedNum=1}renderElem(){this.el=t('<div class="atk-comment-wrap" data-comment-id="">\r\n  <div class="atk-comment">\r\n\r\n    <div class="atk-avatar">\r\n      <a target="_blank"><img src=""></a>\r\n    </div>\r\n\r\n    <div class="atk-comment-main">\r\n\r\n      <div class="atk-header">\r\n        <span class="atk-nick"><a target="_blank"></a></span>\r\n        <span class="atk-badge"></span>\r\n        <span class="atk-date"></span>\r\n        <span class="atk-ua ua-browser"></span>\r\n        <span class="atk-ua ua-os"></span>\r\n      </div>\r\n\r\n      <div class="atk-body">\r\n        <div class="atk-content"></div>\r\n      </div>\r\n\r\n      <div class="atk-footer">\r\n        <div class="atk-comment-actions"></div>\r\n      </div>\r\n\r\n    </div>\r\n\r\n  </div>\r\n</div>\r\n'),this.mainEl=this.el.querySelector(".atk-comment-main"),this.bodyEl=this.el.querySelector(".atk-body"),this.contentEl=this.bodyEl.querySelector(".atk-content"),this.actionsEl=this.el.querySelector(".atk-comment-actions"),this.childrenEl=null,this.unread?this.el.classList.add("atk-unread"):this.el.classList.remove("atk-unread"),this.openable?this.el.classList.add("atk-openable"):this.el.classList.remove("atk-openable"),this.el.addEventListener("click",(t=>{this.openable&&this.openURL&&(t.preventDefault(),window.open(this.openURL)),this.openEvt&&this.openEvt()})),this.el.setAttribute("data-comment-id",`${this.data.id}`),this.el.querySelector(".atk-avatar a").setAttribute("href",this.data.link),this.el.querySelector(".atk-avatar img").setAttribute("src",this.getGravatarUrl());const e=this.el.querySelector(".atk-nick > a");e.innerText=this.data.nick,e.href=this.data.link;const i=this.el.querySelector(".atk-badge");this.data.badge_name?(i.innerText=this.data.badge_name,this.data.badge_color&&(i.style.backgroundColor=this.data.badge_color)):i.remove();const n=this.el.querySelector(".atk-date");if(n.innerText=this.getDateFormatted(),n.setAttribute("data-atk-comment-date",String(+new Date(this.data.date))),this.el.querySelector(".atk-ua.ua-browser").innerText=this.getUserUaBrowser(),this.el.querySelector(".atk-ua.ua-os").innerText=this.getUserUaOS(),this.data.is_collapsed){this.contentEl.classList.add("atk-hide","atk-type-collapsed");const e=t('\n      <div class="atk-collapsed">\n        <span class="atk-text">该评论已被系统或管理员折叠</span>\n        <span class="atk-show-btn">查看内容</span>\n      </div>');this.bodyEl.insertAdjacentElement("beforeend",e);const i=e.querySelector(".atk-show-btn");i.addEventListener("click",(t=>{this.contentEl.classList.contains("atk-hide")?(this.contentEl.innerHTML=this.getContent(),this.contentEl.classList.remove("atk-hide"),p(this.contentEl),i.innerHTML="收起内容"):(this.contentEl.innerHTML="",this.contentEl.classList.add("atk-hide"),i.innerHTML="查看内容"),t.stopPropagation()}))}else this.contentEl.innerHTML=this.getContent();if(this.replyTo){const e=t('\n      <div class="atk-reply-to">\n        <div class="atk-meta">回复 <span class="atk-nick"></span>:</div>\n        <div class="atk-content"></div>\n      </div>');e.querySelector(".atk-nick").innerText=`@${this.replyTo.nick}`;let i=this.replyTo.content;this.replyTo.is_collapsed&&(i="[已折叠]"),e.querySelector(".atk-content").innerHTML=i,this.bodyEl.prepend(e)}if(this.data.is_pending){const e=t('<div class="atk-pending">审核中，仅本人可见。</div>');this.bodyEl.prepend(e)}return this.initActionBtn(),this.afterRender&&this.afterRender(),this.el}eachComment(t,e){0!==t.length&&t.every((i=>!1!==e(i,t)&&(this.eachComment(i.getChildren(),e),!0)))}refreshUI(){const t=this.el,e=this.renderElem();t.replaceWith(e),this.playFadeInAnim(),this.eachComment(this.children,(t=>{t.parent?.getChildrenEl().appendChild(t.renderElem()),t.playFadeInAnim()})),this.ctx.trigger("comments-loaded")}initActionBtn(){const e=t("<span></span>"),i=t("<span></span>");this.actionsEl.append(e),this.actionsEl.append(i);const n=()=>{e.innerText=`赞同 (${this.data.vote_up||0})`,i.innerText=`反对 (${this.data.vote_down||0})`};if(n(),e.onclick=t=>{t.stopPropagation(),new b(this.ctx).vote(this.data.id,"comment_up").then((t=>{this.data.vote_up=t,n()})).catch((t=>{window.alert(`投票失败：${t.msg||String(t)}`)}))},i.onclick=t=>{t.stopPropagation(),new b(this.ctx).vote(this.data.id,"comment_down").then((t=>{this.data.vote_down=t,n()})).catch((t=>{window.alert(`投票失败：${t.msg||String(t)}`)}))},this.data.is_allow_reply){const e=t('<span data-atk-action="comment-reply">回复</span>');this.actionsEl.append(e),e.addEventListener("click",(t=>{this.ctx.trigger("editor-reply",this.data),t.stopPropagation()}))}const s=t(`<span atk-only-admin-show>${this.data.is_collapsed?"取消折叠":"折叠"}</span>`);this.actionsEl.append(s),s.addEventListener("click",(t=>{this.adminEdit("collapsed",s),t.stopPropagation()}));const a=t(`<span atk-only-admin-show>${this.data.is_pending?"待审":"已审"}</span>`);this.actionsEl.append(a),a.addEventListener("click",(t=>{this.adminEdit("pending",a),t.stopPropagation()}));const r=t("<span atk-only-admin-show>删除</span>");this.actionsEl.append(r),r.addEventListener("click",(t=>{this.adminDelete(r),t.stopPropagation()}))}getIsRoot(){return null===this.parent}getChildren(){return this.children}putChild(t){t.parent=this,t.nestedNum=this.nestedNum+1,this.children.push(t),this.getChildrenEl().appendChild(t.getEl()),t.playFadeInAnim()}getChildrenEl(){return null===this.childrenEl&&(this.nestedNum<this.maxNestingNum?(this.childrenEl=t('<div class="atk-comment-children"></div>'),this.mainEl.appendChild(this.childrenEl)):this.parent&&(this.childrenEl=this.parent.getChildrenEl())),this.childrenEl}getParent(){return this.parent}getEl(){return this.el}getData(){return this.data}getGravatarUrl(){return`${this.ctx.conf.gravatar?.cdn||""}${this.data.email_encrypted}?d=${encodeURIComponent(this.ctx.conf.defaultAvatar||"")}&s=80`}getContent(){return this.data.content}getDateFormatted(){return s(new Date(this.data.date))}getUserUaBrowser(){const t=q(this.data.ua);return`${t.browser} ${t.version}`}getUserUaOS(){const t=q(this.data.ua);return`${t.os} ${t.osVersion}`}playFadeInAnim(){p(this.el)}adminEdit(t,e){if(e.classList.contains("atk-in-process"))return;const i=e.innerText;e.classList.add("atk-in-process"),e.innerText="修改中...","collapsed"===t?this.data.is_collapsed=!this.data.is_collapsed:"pending"===t&&(this.data.is_pending=!this.data.is_pending),new b(this.ctx).commentEdit(this.data).then((t=>{e.classList.remove("atk-in-process"),this.data=t,this.refreshUI(),p(this.bodyEl),this.ctx.trigger("list-refresh-ui")})).catch((t=>{console.error(t),e.classList.add("atk-error"),e.innerText="修改失败",setTimeout((()=>{e.innerText=i,e.classList.remove("atk-error"),e.classList.remove("atk-in-process")}),2e3)}))}onDelete;adminDelete(t){if(t.classList.contains("atk-in-process"))return;const e=Number(t.getAttribute("data-btn-clicked")||1);if(e<2){if(1===e){const i=t.innerText;t.innerText="确认删除",setTimeout((()=>{t.innerText=i,t.setAttribute("data-btn-clicked","")}),2e3),t.setAttribute("data-btn-clicked",String(e+1))}return}const i=t.innerText;t.classList.add("atk-in-process"),t.innerText="删除中...",new b(this.ctx).commentDel(this.data.id,this.data.site_name).then((()=>{t.innerText=i,t.classList.remove("atk-in-process"),this.onDelete&&this.onDelete(this)})).catch((e=>{console.error(e),t.classList.add("atk-error"),t.innerText="删除失败",setTimeout((()=>{t.innerText=i,t.classList.remove("atk-error"),t.classList.remove("atk-in-process")}),2e3)}))}setUnread(t){this.unread=t,this.unread?this.el.classList.add("atk-unread"):this.el.classList.remove("atk-unread")}setOpenURL(t){t||(this.openable=!1,this.el.classList.remove("atk-openable")),this.openable=!0,this.openURL=t,this.el.classList.add("atk-openable")}}class B extends u{el;commentsWrapEl;comments=[];data;pageSize=15;offset=0;type;readMoreEl;readMoreLoadingEl;readMoreTextEl;noCommentText;renderComment;paramsEditor;onAfterLoad;isLoading=!1;isFirstLoad=!0;flatMode;unread=[];unreadHighlight=!1;constructor(e){super(e),this.el=t('\n    <div class="atk-list-lite">\n      <div class="atk-list-comments-wrap"></div>\n      <div class="atk-list-read-more" style="display: none;">\n        <div class="atk-loading-icon" style="display: none;"></div>\n        <span class="atk-text">查看更多</span>\n      </div>\n    </div>\n    '),this.commentsWrapEl=this.el.querySelector(".atk-list-comments-wrap"),this.pageSize=this.conf.readMore&&this.conf.readMore.pageSize||this.pageSize,this.readMoreEl=this.el.querySelector(".atk-list-read-more"),this.readMoreLoadingEl=this.readMoreEl.querySelector(".atk-loading-icon"),this.readMoreTextEl=this.readMoreEl.querySelector(".atk-text"),this.readMoreEl.addEventListener("click",(()=>{this.readMore()})),this.noCommentText=this.conf.noComment||"无评论",setInterval((()=>{this.el.querySelectorAll("[data-atk-comment-date]").forEach((t=>{const e=t.getAttribute("data-atk-comment-date");t.innerText=s(new Date(Number(e)))}))}),3e4),this.ctx.on("unread-update",(t=>this.updateUnread(t.notifies)))}async reqComments(t=0){0===t&&this.clearComments(),this.isLoading=!0,this.ctx.trigger("comments-load"),0===t?o(this.el):this.readMoreBtnSetLoading(!0);const e=()=>{this.isLoading=!1,0===t?l(this.el):this.readMoreBtnSetLoading(!1)};let i;try{i=await new b(this.ctx).get(t,this.type,this.flatMode,this.paramsEditor)}catch(n){throw this.onError(n.msg||String(n)),n}finally{e()}if(this.ctx.conf.versionCheck){if(this.apiVersionCheck(i.api_version||{}))return}this.offset=t;try{this.onLoad(i),this.onAfterLoad&&this.onAfterLoad(i)}catch(n){throw this.onError(String(n)),n}finally{e()}}onLoad(t){this.data=t,m(this.el,null),this.importComments(t.comments),this.hasMoreComments?this.showReadMoreBtn():this.hideReadMoreBtn(),this.isFirstLoad&&this.hasMoreComments&&this.initScrollBottomAutoLoad(),this.ctx.trigger("unread-update",{notifies:t.unread||[]}),this.isFirstLoad=!1}onError(e){if(e=String(e),console.error(e),this.isFirstLoad){const i=t(`<span>${e}，无法获取评论列表数据<br/></span>`),n=t('<span style="cursor:pointer;">点击重新获取</span>');n.onclick=()=>{this.reqComments(0)},i.appendChild(n);const s=t('<span atk-only-admin-show> | <span style="cursor:pointer;">打开控制台</span></span>');s.onclick=()=>{this.ctx.trigger("sidebar-show",{viewName:"admin"})},this.ctx.user.data.isAdmin||s.classList.add("atk-hide"),i.appendChild(s),m(this.el,i)}else this.readMoreBtnShowErr(`${e} 获取失败`)}createComment(t){const e=new _(this.ctx,t);return e.afterRender=()=>{this.renderComment&&this.renderComment(e)},e.onDelete=t=>{this.deleteComment(t),this.refreshUI()},e}importComments(t){const e=i=>{const n=t.filter((t=>t.rid===i.data.id));0!==n.length&&n.forEach((t=>{t.is_allow_reply=i.data.is_allow_reply;const n=this.createComment(t);n.renderElem(),i.putChild(n),e(n)}))};this.flatMode?t.forEach((e=>{this.putCommentFlatMode(e,t,"append")})):t.filter((t=>0===t.rid)).forEach((t=>{t.is_collapsed&&(t.is_allow_reply=!1);const i=this.createComment(t);i.renderElem(),this.comments.push(i),this.commentsWrapEl.appendChild(i.getEl()),i.playFadeInAnim(),e(i)})),this.refreshUI(),this.ctx.trigger("comments-loaded")}putCommentFlatMode(t,e,i){t.is_collapsed&&(t.is_allow_reply=!1);const n=this.createComment(t);if(0!==t.rid){const i=e.find((e=>e.id===t.rid));i&&(n.replyTo=i)}n.renderElem(),"append"===i?this.comments.push(n):this.comments.unshift(n),t.visible&&("append"===i?this.commentsWrapEl.appendChild(n.getEl()):this.commentsWrapEl.prepend(n.getEl()),n.playFadeInAnim())}insertComment(t){if(this.flatMode)this.putCommentFlatMode(t,this.comments.map((t=>t.data)),"prepend");else{const e=this.createComment(t);e.renderElem(),0!==t.rid?this.findComment(t.rid)?.putChild(e):(this.commentsWrapEl.prepend(e.getEl()),this.comments.unshift(e)),d(e.getEl()),e.playFadeInAnim()}this.data&&(this.data.total+=1),this.refreshUI(),this.ctx.trigger("comments-loaded")}refreshUI(){const e=this.comments.length<=0;let i=this.commentsWrapEl.querySelector(".atk-list-no-comment");e&&(i||(i=t('<div class="atk-list-no-comment"></div>'),this.commentsWrapEl.appendChild(i),i.innerHTML=this.noCommentText)),!e&&i&&i.remove(),this.ctx.trigger("check-admin-show-el")}getListCommentCount(){return this.data&&this.data.total?Number(this.data.total||"0"):0}get hasMoreComments(){return!!this.data&&this.data.total_parents>this.offset+this.pageSize}async readMore(){const t=this.offset+this.pageSize;await this.reqComments(t)}showReadMoreBtn(){this.readMoreEl.style.display=""}hideReadMoreBtn(){this.readMoreEl.style.display="none"}readMoreBtnSetLoading(t){this.readMoreLoadingEl.style.display=t?"":"none",this.readMoreTextEl.style.display=t?"none":""}readMoreBtnShowErr(t){this.readMoreBtnSetLoading(!1);const e=this.readMoreTextEl.innerText;this.readMoreTextEl.innerText=t,this.readMoreEl.classList.add("atk-err"),setTimeout((()=>{this.readMoreTextEl.innerText=e,this.readMoreEl.classList.remove("atk-err")}),2e3)}initScrollBottomAutoLoad(){this.conf.readMore&&this.conf.readMore.autoLoad&&document.addEventListener("scroll",(()=>{const t=this.el.querySelector(".atk-list-comments-wrap > .atk-comment-wrap:nth-last-child(3)");t&&this.hasMoreComments&&(this.isLoading||c(t)&&this.readMore())}))}eachComment(t,e){0!==t.length&&t.every((i=>!1!==e(i,t)&&(this.eachComment(i.getChildren(),e),!0)))}findComment(t,e){e||(e=this.comments);let i=null;return this.eachComment(e,(e=>e.data.id!==t||(i=e,!1))),i}getCommentCount(){let t=0;return this.eachComment(this.comments,(()=>{t++})),t}deleteComment(t){let e;if("number"==typeof t){if(e=this.findComment(t),!e)throw Error(`未找到评论 ${t}`)}else e=t;e.getEl().remove(),this.eachComment(this.comments,((t,i)=>t!==e||(i.splice(i.indexOf(t),1),!1)))}clearComments(){this.commentsWrapEl.innerHTML="",this.data=void 0,this.comments=[]}updateUnread(t){this.unread=t,this.unreadHighlight&&this.eachComment(this.comments,(t=>{const e=this.unread.find((e=>e.comment_id===t.data.id));e?(t.setUnread(!0),t.setOpenURL(e.read_link),t.openEvt=()=>{this.unread=this.unread.filter((e=>e.comment_id!==t.data.id)),this.ctx.trigger("unread-update",{notifies:this.unread})}):t.setUnread(!1)}))}apiVersionCheck(e){const i=e?.fe_min_version||"0.0.0",n=1===function(t,e){const i=t.split("."),n=e.split(".");for(let s=0;s<3;s++){const t=Number(i[s]),e=Number(n[s]);if(t>e)return 1;if(e>t)return-1;if(!Number.isNaN(t)&&Number.isNaN(e))return 1;if(Number.isNaN(t)&&!Number.isNaN(e))return-1}return 0}(i,"2.0.6");if(n){const e=t(`<div>前端 Artalk 版本已过时，请更新以获得完整体验<br/>若您是站点管理员，请前往 “<a href="https://artalk.js.org/" target="_blank">官方文档</a>” 获取帮助<br/><br/><span style="color: var(--at-color-meta);">前端版本 2.0.6，需求版本 >= ${i}</span><br/><br/></div>`),n=t('<span style="cursor:pointer;">忽略</span>');n.onclick=()=>{m(this.ctx,null),this.ctx.conf.versionCheck=!1,this.reqComments(0)},e.append(n),m(this.ctx,e,'<span class="atk-warn-title">Artalk Warn</span>')}return n}}class U extends B{closeCommentBtnEl;openSidebarBtnEl;openAdminPanelBtnEl;unreadBadgeEl;constructor(e){super(e);const i=t('<div class="atk-list">\r\n  <div class="atk-list-header">\r\n    <div class="atk-comment-count">\r\n      <span class="atk-comment-count-num">0</span>\r\n      条评论\r\n    </div>\r\n    <div class="atk-right-action">\r\n      <span data-action="admin-close-comment" class="atk-hide" atk-only-admin-show>关闭评论</span>\r\n      <span data-action="open-admin-panel" class="atk-hide atk-on" atk-only-admin-show>控制台</span>\r\n      <span data-action="open-sidebar" class="atk-hide atk-on">\r\n        <span class="atk-unread-badge" style="display: none;"></span>\r\n        通知中心\r\n      </span>\r\n    </div>\r\n  </div>\r\n  <div class="atk-list-body"></div>\r\n  <div class="atk-list-footer">\r\n    <div class="atk-copyright"></div>\r\n  </div>\r\n</div>\r\n');i.querySelector(".atk-list-body").append(this.el),this.el=i,this.flatMode=this.ctx.conf.flatMode||!1,this.initListActionBtn(),this.el.querySelector(".atk-copyright").innerHTML='Powered By <a href="https://artalk.js.org" target="_blank" title="Artalk v2.0.6">Artalk</a>',this.ctx.on("list-reload",(()=>this.reqComments(0))),this.ctx.on("list-refresh-ui",(()=>this.refreshUI())),this.ctx.on("list-import",(t=>this.importComments(t))),this.ctx.on("list-insert",(t=>this.insertComment(t))),this.ctx.on("list-delete",(t=>this.deleteComment(t.id))),this.ctx.on("list-update",(t=>{t(this.data),this.refreshUI()})),this.ctx.on("unread-update",(t=>this.showUnreadBadge(t.notifies?.length||0)))}refreshUI(){super.refreshUI(),this.el.querySelector(".atk-comment-count-num").innerText=String(this.getListCommentCount()),this.ctx.user.data.nick&&this.ctx.user.data.email?this.openSidebarBtnEl.classList.remove("atk-hide"):this.openSidebarBtnEl.classList.add("atk-hide"),this.ctx.trigger("check-admin-show-el"),this.data&&this.data.page&&!0===this.data.page.admin_only?(this.ctx.trigger("editor-close"),this.closeCommentBtnEl.innerHTML="打开评论"):(this.ctx.trigger("editor-open"),this.closeCommentBtnEl.innerHTML="关闭评论")}onLoad(t){super.onLoad(t),this.checkGoToCommentByUrlHash()}async checkGoToCommentByUrlHash(){let t=Number(e("atk_comment"));if(!t){const e=window.location.hash.match(/#atk-comment-([0-9]+)/);if(!e||!e[1]||Number.isNaN(Number(e[1])))return;t=Number(e[1])}if(!t)return;const i=this.findComment(t);i||this.hasMoreComments&&await this.readMore(),i&&(d(i.getEl(),!1),setTimeout((()=>{i.getEl().classList.add("atk-flash-once");const t=e("atk_notify_key");t&&new b(this.ctx).markRead(t).then((()=>{this.unread=this.unread.filter((t=>t.comment_id!==i.data.id)),this.ctx.trigger("unread-update",{notifies:this.unread})}))}),800))}initListActionBtn(){this.openSidebarBtnEl=this.el.querySelector('[data-action="open-sidebar"]'),this.openSidebarBtnEl.addEventListener("click",(()=>{this.ctx.trigger("sidebar-show",{viewName:"message"})})),this.openAdminPanelBtnEl=this.el.querySelector('[data-action="open-admin-panel"]'),this.openAdminPanelBtnEl.addEventListener("click",(()=>{this.ctx.trigger("sidebar-show",{viewName:"admin"})})),this.closeCommentBtnEl=this.el.querySelector('[data-action="admin-close-comment"]'),this.closeCommentBtnEl.addEventListener("click",(()=>{this.data&&(this.data.page.admin_only=!this.data.page.admin_only,this.adminPageEditSave())})),this.unreadBadgeEl=this.el.querySelector(".atk-unread-badge")}adminPageEditSave(){this.data&&this.data.page&&(this.ctx.trigger("editor-show-loading"),new b(this.ctx).pageEdit(this.data.page).then((t=>{this.data&&(this.data.page={...t}),this.refreshUI()})).catch((t=>{this.ctx.trigger("editor-notify",{msg:`修改页面数据失败：${t.msg||String(t)}`,type:"e"})})).finally((()=>{this.ctx.trigger("editor-hide-loading")})))}showUnreadBadge(t){t>0?(this.unreadBadgeEl.innerText=`${Number(t||0)}`,this.unreadBadgeEl.style.display="block"):this.unreadBadgeEl.style.display="none"}}class N extends u{constructor(e){super(e),this.el=t('<div class="atk-sidebar-view"></div>')}name="";title=this.name;actions={};activeAction;adminOnly=!1;init(){}switch(t){}}class R extends N{name="message";title="通知中心";actions={mentions:"提及",all:"全部",mine:"我的",pending:"待审"};activeAction="";list;type="mentions";init(){this.list=W(this.ctx),this.el.innerHTML="",this.el.append(this.list.el),this.activeAction=this.type,this.switch(this.type)}switch(t){this.list&&(this.type=t,this.list.type=t,this.list.isFirstLoad=!0,this.list.reqComments())}}function W(t){const e=new B(t);return e.flatMode=!0,e.unreadHighlight=!0,e.noCommentText='<div class="atk-sidebar-no-content">无内容</div>',e.renderComment=t=>{t.setOpenURL(`${t.data.page_key}#atk-comment-${t.data.id}`)},e}class I extends N{name="admin";title="控制台";actions={comment:"评论",page:"页面",site:"站点",setting:"配置"};activeAction="";adminOnly=!0;cListInstance;get cList(){return this.cListInstance||(this.cListInstance=W(this.ctx)),this.cListInstance}constructor(e){super(e),this.el=t('<div class="atk-msg-center"></div>')}init(){this.activeAction="comment",this.switch("comment")}switch(t){this.el.innerHTML="","comment"===t?this.initCommentList():"page"===t?this.initPageList():"site"===t?this.initSiteList():"setting"===t&&this.initSetting()}async initSiteFilterBar(t){const e=await new b(this.ctx).siteGet(),i=[{name:"__ATK_SITE_ALL",label:"全部站点"}];e&&e.forEach((t=>{i.push({name:t.name,label:t.name})}));return P(i,(e=>t(e)))}async initCommentList(){const e=t('<div class="atk-admin-comment-list"></div>');e.append(this.cList.el);const i=(t,e)=>{this.cList&&(this.cList.type=`admin_${t}`,this.cList.isFirstLoad=!0,this.cList.paramsEditor=t=>{t.site_name=e},this.cList.reqComments())};let n=!1;const s={typeName:"all",siteName:""},a=P([{name:"all",label:"全部"},{name:"pending",label:"待审"}],(t=>{n&&(s.typeName=t.name,i(s.typeName,s.siteName))}));e.prepend(a);const r=await this.initSiteFilterBar((t=>{s.siteName=t.name,i(s.typeName,s.siteName)}));e.prepend(r),n=!0,this.el.innerHTML="",this.el.append(e)}async initPageList(){const e=t('<div class="atk-admin-page-list"></div>'),i=t('<div class="atk-sidebar-list"></div>');e.append(i);const n=await this.initSiteFilterBar((t=>{this.reqPages(i,t.name)}));e.prepend(n),this.el.innerHTML="",this.el.append(e)}async reqPages(e,i){e.innerHTML="";const n=await new b(this.ctx).pageGet(i);n?n.forEach((n=>{const s=t('\n      <div class="atk-item">\n      <div class="atk-title"></div>\n      <div class="atk-sub"></div>\n      <div class="atk-actions">\n        <div class="atk-item" data-action="page-edit-title">修改标题</div>\n        <div class="atk-item" data-action="page-fetch">获取标题</div>\n        <div class="atk-item" data-action="page-edit-key">修改 KEY</div>\n        <div class="atk-item" data-action="page-admin-only"></div>\n        <div class="atk-item" data-action="page-del">删除</div>\n      </div>\n      </div>');e.append(s),s.setAttribute("data-page-id",String(n.id));const a=s.querySelector(".atk-title"),r=s.querySelector(".atk-sub");a.innerText=n.title||n.key,r.innerText=n.key,a.onclick=()=>{window.open(`${n.url}`)},r.onclick=()=>{window.open(`${n.url}`)};const o=s.querySelector('[data-action="page-admin-only"]'),l=()=>{o.innerText=n.admin_only?"仅管理员可评":"所有人可评"};l(),o.onclick=t=>{t.stopPropagation(),n.admin_only=!n.admin_only,new b(this.ctx).pageEdit(n).then((t=>{n=t,l()}))};s.querySelector('[data-action="page-edit-title"]').onclick=()=>{const t=window.prompt("修改标题：",n.title);null!==t&&(n.title=t,new b(this.ctx).pageEdit(n).then((()=>{this.reqPages(e,i)})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)})))};const c=s.querySelector('[data-action="page-fetch"]');c.onclick=()=>{const t=c.innerText;c.innerText="获取中...",new b(this.ctx).pageFetch(n.id).then((t=>{n=t,s.querySelector(".atk-title").innerText=t.title})).catch((t=>{window.alert(`获取失败：${t.msg||"未知错误"}`)})).finally((()=>{c.innerText=t}))};s.querySelector('[data-action="page-edit-key"]').onclick=()=>{const t=window.prompt("修改 Key：",n.key);null!==t&&(n.key=t,new b(this.ctx).pageEdit(n).then((()=>{this.reqPages(e,i)})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)})))};s.querySelector('[data-action="page-del"]').onclick=()=>{window.confirm(`确认删除页面 "${n.title||n.key}"？将会删除所有相关数据`)&&(()=>{new b(this.ctx).pageDel(n.key,n.site_name).then((()=>{s.remove()})).catch((t=>{window.alert(`删除失败 ${String(t)}`)}))})()}})):e.innerHTML='<div class="atk-sidebar-no-content">无内容</div>'}async initSiteList(){const e=t('<div class="atk-site-list"></div>'),i=t('\n    <div class="atk-sidebar-list">\n      <div class="atk-site-add atk-form-inline-wrap">\n        <input type="text" name="siteAdd_name" placeholder="Name..." />\n        <input type="text" name="siteAdd_urls" placeholder="URL..." />\n        <button name="siteAdd_submit">Add</button>\n      </div>\n    </div>\n    ');e.append(i);const n=i.querySelector('[name="siteAdd_name"]'),s=i.querySelector('[name="siteAdd_urls"]');i.querySelector('[name="siteAdd_submit"]').onclick=()=>{const t=n.value.trim(),e=s.value.trim();""!==t?new b(this.ctx).siteAdd(t,e).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`创建失败：${t.msg||""}`)})):n.focus()};const a=await new b(this.ctx).siteGet();a?(a.forEach((e=>{const n=t('\n      <div class="atk-item">\n      <div class="atk-title"></div>\n      <div class="atk-sub"></div>\n      <div class="atk-actions">\n        <div class="atk-item" data-action="site-rename">重命名</div>\n        <div class="atk-item" data-action="site-edit-urls">修改 URL</div>\n        <div class="atk-item" data-action="site-del">删除</div>\n      </div>\n      </div>');i.append(n),n.setAttribute("data-site-id",String(e.id));const s=n.querySelector(".atk-title"),a=n.querySelector(".atk-sub");s.innerText=e.name||e.first_url,s.onclick=()=>{window.open(`${e.first_url}`)},e.urls&&e.urls.forEach((e=>{const i=t('<span style="margin-right: 10px;" />');i.innerText=e,i.onclick=()=>{window.open(`${e}`)},a.append(i)}));n.querySelector('[data-action="site-del"]').onclick=()=>{window.confirm(`确认删除站点 "${e.name||e.first_url}"？将会删除所有相关数据`)&&(()=>{new b(this.ctx).siteDel(e.id,!0).then((()=>{n.remove()})).catch((t=>{window.alert(`删除失败 ${String(t)}`)}))})()};n.querySelector('[data-action="site-edit-urls"]').onclick=()=>{const t=window.prompt("修改 URL (多个 URL 用逗号隔开):",e.urls_raw);null!==t&&new b(this.ctx).siteEdit(e.id,{name:e.name,urls:t}).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)}))};n.querySelector('[data-action="site-rename"]').onclick=()=>{const t=window.prompt("编辑站点名称：",e.name);null!==t&&new b(this.ctx).siteEdit(e.id,{name:t,urls:e.urls_raw}).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)}))}})),this.el.innerHTML="",this.el.append(e)):e.append(t('<div class="atk-sidebar-no-content">无内容</div>'))}initSetting(){const e=t('<div class="atk-admin-setting"></div>'),i=t('\n    <div class="atk-setting">\n    <div class="atk-log-wrap" style="display: none;">\n      <div class="atk-log-back-btn">返回</div>\n      <div class="atk-log"></div>\n    </div>\n    <div class="atk-group atk-importer atk-form-wrap">\n    <div class="atk-title">导入评论数据</div>\n    <div class="atk-label">数据类型</div>\n    <select name="importer_dataType">\n      <option value="artrans">Artrans (数据行囊)</option>\n      <option value="artalk_v1">Artalk v1 (PHP 旧版)</option>\n      <option value="typecho">Typecho</option>\n      <option value="wordpress">WordPress</option>\n      <option value="disqus">Disqus</option>\n      <option value="commento">Commento</option>\n      <option value="valine">Valine</option>\n      <option value="twikoo">Twikoo</option>\n    </select>\n    <input type="file" name="importer_dataFile" accept="text/plain,.json" />\n    <div class="atk-label">目标站点名</div>\n    <input type="text" name="importer_siteName" />\n    <div class="atk-label">目标站点 URL</div>\n    <input type="text" name="importer_siteUrl" />\n    <div class="atk-label">启动参数</div>\n    <textarea name="importer_payload"></textarea>\n    <span class="atk-desc">启动参数请查阅：“<a href="https://artalk.js.org/guide/transfer.html" target="_blank">文档 · 数据搬家</a>”</span>\n    <button class="atk-btn" name="importer_submit">导入</button>\n    </div>\n    </div>');e.append(i);const n=i.querySelector(".atk-form-wrap"),s=i.querySelector(".atk-log-wrap"),a=s.querySelector(".atk-log"),r=s?.querySelector(".atk-log-back-btn");r.onclick=()=>{s.style.display="none",n.style.display=""};const o=i.querySelector('[name="importer_dataType"]'),l=i.querySelector('[name="importer_dataFile"]'),c=i.querySelector('[name="importer_siteName"]'),d=i.querySelector('[name="importer_siteUrl"]'),h=i.querySelector('[name="importer_payload"]');o.onchange=()=>{["typecho"].includes(o.value)?l.style.display="none":l.style.display=""};i.querySelector('[name="importer_submit"]').onclick=()=>{const t=o.value.trim(),e=c.value.trim(),i=d.value.trim(),r=h.value.trim();if(""===t)return void window.alert("请选择数据类型");const p=o=>{s.style.display="",n.style.display="none";const l="f_"+ +new Date,c=document.createElement("iframe");c.className="atk-iframe",c.name=l,a.innerHTML="",a.append(c);const d=document.createElement("form");d.style.display="none",d.setAttribute("method","post"),d.setAttribute("action",`${this.ctx.conf.server}/admin/artransfer`),d.setAttribute("target",l);let h={};if(r){try{h=JSON.parse(r)}catch(m){window.alert(`Payload JSON 格式有误：${String(m)}`)}h instanceof Object&&window.alert("Payload 需为 JSON 对象")}e&&(h.t_name=e),i&&(h.t_url=i),o&&(h.json_data=o);const p={type:t,payload:JSON.stringify(h),token:this.ctx.user.data.token||""};Object.entries(p).forEach((([t,e])=>{const i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",t),i.value=e,d.appendChild(i)})),s.append(d),d.submit(),d.remove()},m=new FileReader;m.onload=()=>{const t=String(m.result);p(t)},l.files?.length?m.readAsText(l.files[0]):p()},this.el.innerHTML="",this.el.append(e)}}function P(e,i){const n=t('<div class="atk-filter-bar"></div>');return e.forEach((e=>{const s=t("<span></span>");n.append(s),s.innerText=e.label,s.addEventListener("click",(()=>{i(e),n.querySelectorAll(".atk-active").forEach((t=>t.classList.remove("atk-active"))),s.classList.add("atk-active")}))})),n.firstChild.click(),n}class H extends u{el;layer;actionsEl;contentEl;titleWrapEl;view;action;isFirstShow=!0;viewInstances={};registerViews=[R,I];constructor(e){super(e),this.el=t('<div class="atk-sidebar">\r\n  <div class="atk-sidebar-inner">\r\n    <div class="atk-sidebar-title-wrap"><span class="atk-title-item atk-active"></span></div>\r\n    <div class="atk-sidebar-close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></div>\r\n    <div class="atk-sidebar-actions"></div>\r\n    <div class="atk-sidebar-content"></div>\r\n  </div>\r\n</div>\r\n'),this.contentEl=this.el.querySelector(".atk-sidebar-content"),this.titleWrapEl=this.el.querySelector(".atk-sidebar-title-wrap"),this.actionsEl=this.el.querySelector(".atk-sidebar-actions"),this.el.querySelector(".atk-sidebar-close").addEventListener("click",(()=>{this.hide()})),this.ctx.on("sidebar-show",(t=>this.show(t?.viewName))),this.ctx.on("sidebar-hide",(()=>this.hide())),this.registerViews.forEach((e=>{const i=new e(this.ctx);this.viewInstances[i.name]=i,i.el.classList.add(`atk-sidebar-view-${i.name}`);const n=t(`\n      <span class="atk-title-item" data-name="${i.name}">${i.title}</span>\n      `);i.adminOnly&&(n.setAttribute("atk-only-admin-show",""),this.ctx.user.data.isAdmin||n.classList.add("atk-hide")),this.titleWrapEl.append(n),n.addEventListener("click",(()=>{this.switchView(i)}))}))}show(t){this.el.style.transform="",this.layer=k(this.ctx,"sidebar",this.el),this.layer.show(),this.contentEl.scrollTo(0,0),setTimeout((()=>{this.el.style.transform="translate(0, 0)"}),20),t&&this.switchViewByName(t),this.isFirstShow&&(t||this.switchViewByName("message"),this.isFirstShow=!1)}hide(){this.el.style.transform="",this.layer?.dispose()}switchViewByName(t){this.viewInstances[t]?this.switchView(this.viewInstances[t]):console.error(`未找到 view: ${t}`)}switchView(e){this.view=e;const i=this.titleWrapEl.querySelector(`[data-name=${e.name}]`);this.titleWrapEl.querySelector(".atk-active").innerText=e.title,this.titleWrapEl.querySelectorAll(".atk-title-item").forEach((t=>{t.classList.contains("atk-active")||(t.style.display="")})),i.style.display="none",e.init(),this.contentEl.innerHTML="",this.contentEl.append(e.el),this.actionsEl.innerHTML="",Object.entries(e.actions).forEach((([i,n])=>{const s=t(`<span class="atk-action-item">${n}</span>`);this.actionsEl.append(s),e.activeAction===i&&s.classList.add("atk-active"),s.addEventListener("click",(()=>{e.switch(i),e.activeAction=i,this.actionsEl.querySelectorAll(".atk-active").forEach((t=>{t.classList.remove("atk-active")})),s.classList.add("atk-active")}))}))}}const D={el:"",placeholder:"来啊，快活啊 ( ゜- ゜)",noComment:"快来成为第一个评论的人吧~",sendBtn:"发送评论",defaultAvatar:"mp",pageKey:"",server:"",site:"",emoticons:{"颜表情":{inputType:"emoticon",container:{Hi:"|´・ω・)ノ","开心":"ヾ(≧∇≦*)ゝ","星星眼":"(☆ω☆)","掀桌":"（╯‵□′）╯︵┴─┴","流口水":"￣﹃￣","捂脸":"(/ω＼)","给跪":"∠( ᐛ 」∠)＿","哈？":"(๑•̀ㅁ•́ฅ)","斜眼":"→_→","加油":"୧(๑•̀⌄•́๑)૭","有木有WiFi":"٩(ˊᗜˋ*)و","前方高能预警":"(ノ°ο°)ノ","纳尼":"(´இ皿இ｀)","吓死惹":"⌇●﹏●⌇","已阅留爪":"(ฅ´ω`ฅ)","去吧大师球":"(╯°A°)╯︵○○○","太萌惹":"φ(￣∇￣o)","咦咦咦":'ヾ(´･ ･｀｡)ノ"',"气呼呼":"( ง ᵒ̌皿ᵒ̌)ง⁼³₌₃","我受到了惊吓":"(ó﹏ò｡)","什么鬼":"Σ(っ °Д °;)っ","摸摸头":'( ,,´･ω･)ﾉ"(´っω･｀｡)',"无奈":"╮(╯▽╰)╭ ","脸红":"o(*////▽////*)q ","悲哀":"＞﹏＜","静静地看着你":'( ๑´•ω•) "(ㆆᴗㆆ)',"不要哇":"(｡•ˇ‸ˇ•｡)"}},Emoji:{inputType:"emoji",container:["😀","😃","😄","😁","😆","😅","😂","😊","😉","👀","😌","😍","😘","😋","😜","😝","😎","😏","😒","😟","😕","😖","😫","😩","😠","😲","😵","😳","😱","😨","😢","😭","😷","✋","✌️","👊","👋","👏","👍","👎","❤️","🎉","🚀"]}},gravatar:{cdn:"https://sdn.geekzu.org/avatar/"},darkMode:!1,reqTimeout:15e3,flatMode:!1,maxNesting:3,versionCheck:!0};return class{ctx;conf;el;contextID=(new Date).getTime();checker;editor;list;sidebar;comments=[];constructor(t){this.conf={...D,...t},this.conf.server=this.conf.server.replace(/\/$/,""),this.conf.pageKey||(this.conf.pageKey=window.location.href.split("#")[0]);try{const t=document.querySelector(this.conf.el);if(null===t)throw Error(`Sorry, Target element "${this.conf.el}" was not found.`);this.el=t}catch(e){throw console.error(e),new Error("Artalk config `el` error")}this.ctx=new r(this.el,this.conf),this.el.classList.add("artalk"),this.el.setAttribute("atk-run-id",this.contextID.toString()),""!==this.el.innerHTML.trim()&&(this.el.innerHTML=""),this.initDarkMode(),this.checker=new C(this.ctx),this.editor=new $(this.ctx),this.list=new U(this.ctx),this.sidebar=new H(this.ctx),this.el.appendChild(this.editor.el),this.el.appendChild(this.list.el),this.el.appendChild(this.sidebar.el),this.list.reqComments(),window.addEventListener("hashchange",(()=>{this.list.checkGoToCommentByUrlHash()})),this.ctx.on("check-admin-show-el",(()=>{const t=[];this.el.querySelectorAll("[atk-only-admin-show]").forEach((e=>t.push(e)));const{wrapEl:e}=y(this.ctx);e&&e.querySelectorAll("[atk-only-admin-show]").forEach((e=>t.push(e))),t.forEach((t=>{this.ctx.user.data.isAdmin?t.classList.remove("atk-hide"):t.classList.add("atk-hide")}))})),this.ctx.on("user-changed",(()=>{this.ctx.trigger("check-admin-show-el"),this.ctx.trigger("list-refresh-ui")}))}initDarkMode(){this.conf.darkMode?this.el.classList.add(g):this.el.classList.remove(g);const{wrapEl:t}=y(this.ctx);t&&(this.conf.darkMode?t.classList.add(g):t.classList.remove(g))}setDarkMode(t){this.ctx.conf.darkMode=t,this.initDarkMode()}openDarkMode(){this.setDarkMode(!0)}closeDarkMode(){this.setDarkMode(!1)}on(t,e){this.ctx.on(t,e,"external")}off(t,e){this.ctx.off(t,e,"external")}trigger(t,e){this.ctx.trigger(t,e,"external")}}}));
